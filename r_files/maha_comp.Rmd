---
title: "mahalanobis_comp"
output: html_document
---

PRIMARY PURPOSE: 
The purpose of this .Rmd is to find an appropriate cut off mahalanobis distnace.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret) 
library(ggplot2)
library(dplyr)
library(readr)
library(Hmisc)
library(ggfortify)
```



```{r}
#___________________________________________________________________________________________________
#### FINDING CUT-OFF MAHALANOBIS DISTANCE via COMPARISON TO THE CHI-SQUARE DISTRIBUTION 
#___________________________________________________________________________________________________
#### looking at distances 
hist(mse$rf_mal)
summary(mse$rf_mal)


#### finding outlier cut-off  
outlier <- data.frame(sys = mse_try$rf_pred_sys, dia = mse_try$rf_pred_dia)


#### finding cut-offs 
threshold <- sqrt(qchisq(p = 0.95, df = 2))


# set cutoff using chi square distribution
threshold <- sqrt(qchisq(ppoints(1204), df = 2,lower.tail = FALSE)) # df = no of columns

# find outliers
mse_try$rf_mal[which(mse_try$rf_mal < threshold)] # gives the row numbers of outliers
outlier <- mse_try$rf_mal
outlier <- as.data.frame(outlier)
outlier$color <- as.factor(ifelse(mse_try$rf_mal >= 93 ,"over","under"))
quantile(outlier, 0.95)


#### visualizing cutoff 
qqplot(qchisq(ppoints(1204), df = 2), mse_try$rf_mal,
       main = expression("Q-Q plot of Mahalanobis" * ~outlier^2 *
                         " vs. quantiles of" * ~ chi[2]^2),xlab = "Chi-Square",ylab = "Mahalanobis")

```


```{r}
#___________________________________________________________________________________________________
#### VISUALIZING OUTLIERS 
#___________________________________________________________________________________________________
outlier %>% ggplot(aes(sqrt(outlier), fill=color)) + geom_histogram() + theme_minimal() +labs(x = "Distance Between True and Predicted Blood Pressure") + guides(fill=guide_legend(title="95 Percentile"))
```




```{r}
    linear = lm(sys_mean~ridageyr+bmxwt,lin_frame_clean)
    prediction_frame <- data.frame(ridageyr = 40,bmxwt = 50)
    prediction <- predict(linear, newdata = prediction_frame)
    prediction <- as.data.frame(prediction)
    observed <- data.frame(number = 100)
    distance <- mahalanobis(prediction, observed, cov(prediction,observed))
```

